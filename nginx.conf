# Map to check authorization token
map_hash_bucket_size 128;

map $http_authorization $auth_valid {
    default 0;
    "Bearer FOCUS_Corporation_a4e83f94514e155693c499c256e57a38" 1;
}

server {
    listen 80;
    server_name _;

    # Increase timeouts for Ollama streaming responses
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;

    location / {
        # Check token
        if ($auth_valid = 0) {
            return 401 '{"error": "Unauthorized - Invalid or missing token"}';
        }

        # Proxy to Ollama
        proxy_pass http://localhost:11434;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Support for streaming
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
    }
}

server {
    listen 9100;
    server_name _;

    # Increase timeouts for Ollama streaming responses
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;

    location / {
        # Check token
        if ($auth_valid = 0) {
            return 401 '{"error": "Unauthorized - Invalid or missing token"}';
        }

        # Proxy to Ollama
        proxy_pass http://localhost:11434;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Support for streaming
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
    }
}

